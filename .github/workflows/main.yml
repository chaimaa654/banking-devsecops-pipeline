name: DVWA DevSecOps Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: dvwa
  IMAGE_TAG: ${{ github.sha }}
  # ğŸ”§ MODE APPRENTISSAGE - Security Gates dÃ©sactivÃ©s pour DVWA
  BLOCK_ON_VULNERABILITIES: false

jobs:
  # ==========================
  # 1ï¸âƒ£ SAST â€“ SonarCloud
  # ==========================
  sast_scan:
    name: SAST - SonarCloud Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=chaimaa654_banking-devsecops-pipeline
            -Dsonar.organization=chaimaa654
            -Dsonar.sources=DVWA
            -Dsonar.qualitygate.wait=false
        continue-on-error: true

      - name: SAST Results Summary
        run: |
          echo "ğŸ“Š =========================="
          echo "ğŸ“Š SAST SCAN COMPLETED"
          echo "ğŸ“Š =========================="
          echo "âš ï¸  DVWA is intentionally vulnerable - results are for learning"
          echo "ğŸ”“ Security Gate: DISABLED (Learning Mode)"
          echo "âœ… Continuing pipeline for DAST testing..."

  # ====================================
  # 2ï¸âƒ£ SECRET SCANNING â€“ Gitleaks
  # ====================================
  secret_scan:
    name: Secret Scanning - Gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: Secret Scan Summary
        run: |
          echo "ğŸ” Secret scanning completed"
          echo "ğŸ”“ Security Gate: DISABLED (Learning Mode)"

  # ==================================
  # 3ï¸âƒ£ SCA â€“ Trivy Filesystem Scan
  # ==================================
  sca_scan:
    name: SCA - Trivy Filesystem Scan
    runs-on: ubuntu-latest
    needs: [sast_scan, secret_scan]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy jq

      - name: Trivy SCA Scan
        run: |
          echo "ğŸ” Running Trivy Filesystem Scan..."
          trivy fs --severity HIGH,CRITICAL ./DVWA
        continue-on-error: true

      - name: Generate SCA Report
        run: |
          trivy fs --format json --output trivy-sca-report.json ./DVWA

      - name: Analyze SCA Results
        run: |
          echo ""
          echo "ğŸ“Š =========================="
          echo "ğŸ“Š SCA SCAN RESULTS"
          echo "ğŸ“Š =========================="
          
          if [ -f "trivy-sca-report.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-sca-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-sca-report.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-sca-report.json)
            
            echo "ğŸ”´ Critical: $CRITICAL"
            echo "ğŸŸ  High: $HIGH"
            echo "ğŸŸ¡ Medium: $MEDIUM"
            echo ""
            echo "âš ï¸  DVWA Analysis: This app is intentionally vulnerable"
            echo "ğŸ“š Purpose: Security training and testing"
            echo "ğŸ”“ Security Gate: DISABLED (Learning Mode)"
            echo "âœ… Continuing to next stage..."
          fi

      - name: Upload SCA Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sca-report
          path: trivy-sca-report.json

      - name: SCA Security Gate (Learning Mode)
        run: |
          echo "ğŸ”“ =========================="
          echo "ğŸ”“ SECURITY GATE: LEARNING MODE"
          echo "ğŸ”“ =========================="
          
          if [ "${{ env.BLOCK_ON_VULNERABILITIES }}" = "true" ]; then
            echo "ğŸ”’ Security Gate would be ENFORCED in production"
            # Dans un vrai projet, dÃ©commentez les lignes suivantes:
            # if [ "$CRITICAL" -gt 5 ]; then
            #   echo "âŒ BLOCKED: Too many critical vulnerabilities"
            #   exit 1
            # fi
          else
            echo "âœ… Security Gate BYPASSED for learning purposes"
            echo "ğŸ’¡ Tip: Set BLOCK_ON_VULNERABILITIES=true for real projects"
          fi

  # ====================================
  # 4ï¸âƒ£ Docker Build & Image Security
  # ====================================
  image_scan:
    name: Docker Image Build & Scan
    runs-on: ubuntu-latest
    needs: sca_scan
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          echo "ğŸ—ï¸ Building Docker image..."
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./DVWA
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.IMAGE_NAME }}:latest
          echo "âœ… Image built successfully"

      - name: Trivy Image Scan
        run: |
          echo "ğŸ” Running Trivy Image Scan..."
          trivy image --severity HIGH,CRITICAL ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        continue-on-error: true

      - name: Generate Image Scan Report
        run: |
          trivy image --format json --output trivy-image-report.json ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Analyze Image Scan Results
        run: |
          sudo apt-get install -y jq
          
          echo ""
          echo "ğŸ“Š =========================="
          echo "ğŸ“Š IMAGE SCAN RESULTS"
          echo "ğŸ“Š =========================="
          
          if [ -f "trivy-image-report.json" ]; then
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-image-report.json)
            HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-image-report.json)
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-image-report.json)
            
            echo "ğŸ”´ Critical: $CRITICAL"
            echo "ğŸŸ  High: $HIGH"
            echo "ğŸŸ¡ Medium: $MEDIUM"
            echo ""
            echo "âš ï¸  DVWA is intentionally vulnerable"
            echo "ğŸ”“ Security Gate: DISABLED (Learning Mode)"
            echo "âœ… Image will be pushed for DAST testing..."
          fi

      - name: Upload Image Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.json

      - name: Image Security Gate (Learning Mode)
        run: |
          echo "ğŸ”“ =========================="
          echo "ğŸ”“ IMAGE SECURITY GATE: LEARNING MODE"
          echo "ğŸ”“ =========================="
          
          if [ "${{ env.BLOCK_ON_VULNERABILITIES }}" = "true" ]; then
            echo "ğŸ”’ In production mode, this would block deployment"
            echo "ğŸ“‹ Recommendation: Fix vulnerabilities before production"
          else
            echo "âœ… Security Gate BYPASSED for DVWA testing"
            echo "ğŸ¯ Proceeding to push image and run DAST..."
          fi

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REPO_USER }}
          password: ${{ secrets.REPO_PWD }}

      - name: Push Docker Image
        run: |
          echo "ğŸ“¤ Pushing image to registry..."
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest
          echo "âœ… Image pushed successfully"

  # =====================================
  # 5ï¸âƒ£ DAST â€“ ZAP Security Testing
  # =====================================
  dast_scan:
    name: DAST - ZAP Security Scan
    runs-on: ubuntu-latest
    needs: image_scan
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REPO_USER }}
          password: ${{ secrets.REPO_PWD }}

      - name: Pull Docker Image
        run: |
          echo "ğŸ“¥ Pulling image from registry..."
          docker pull ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest
          echo "âœ… Image pulled successfully"

      - name: Create Docker Network
        run: |
          docker network create dvwa-net || true

      - name: Deploy DVWA Staging
        run: |
          echo "ğŸš€ Deploying DVWA to staging..."
          docker run -d \
            --name dvwa-staging \
            --network dvwa-net \
            -p 8080:80 \
            -e RECAPTCHA_PRIV_KEY='' \
            -e RECAPTCHA_PUB_KEY='' \
            ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest
          echo "âœ… DVWA container started"

      - name: Wait for DVWA to Start
        run: |
          echo "ğŸ” Waiting for DVWA to be ready..."
          echo "â±ï¸ This may take up to 5 minutes..."
          
          SUCCESS=false
          for i in {1..60}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 2>/dev/null || echo "000")
            
            if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "302" ]]; then
              echo "âœ… DVWA is ready! (HTTP $HTTP_CODE)"
              echo "ğŸŒ Application URL: http://localhost:8080"
              curl -I http://localhost:8080 2>/dev/null || true
              SUCCESS=true
              break
            fi
            
            echo "â³ Attempt $i/60 - HTTP Code: $HTTP_CODE - waiting 5s..."
            sleep 5
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ DVWA failed to start after 5 minutes!"
            echo "ğŸ“‹ Container logs:"
            docker logs dvwa-staging
            echo ""
            echo "ğŸ” Container status:"
            docker ps -a | grep dvwa-staging
            exit 1
          fi
          
          echo ""
          echo "ğŸ‰ DVWA is fully operational!"
          echo "ğŸ”’ Ready for security testing..."

      - name: DVWA Health Check
        run: |
          echo "ğŸ¥ Running health checks..."
          echo ""
          echo "ğŸ“Š Container Status:"
          docker ps | grep dvwa-staging
          echo ""
          echo "ğŸŒ HTTP Response:"
          curl -s -I http://localhost:8080 | head -n 10
          echo ""
          echo "ğŸ” Application Response Test:"
          curl -s http://localhost:8080 | grep -i "dvwa\|login\|damn" | head -n 5 || echo "Response received"

      - name: Create ZAP Reports Directory
        run: |
          mkdir -p zap-reports
          chmod 777 zap-reports

      # ğŸ”¹ PASSIVE SCAN - Baseline
      - name: ZAP Baseline Scan (Passive)
        run: |
          echo ""
          echo "ğŸ” =========================="
          echo "ğŸ” ZAP BASELINE SCAN (Passive)"
          echo "ğŸ” =========================="
          echo "ğŸ“ This scan will spider the application and identify issues passively"
          echo ""
          
          docker run --rm \
            --network dvwa-net \
            -v $(pwd)/zap-reports:/zap/wrk:rw \
            ghcr.io/zaproxy/zap-stable:latest \
            zap-baseline.py \
            -t http://dvwa-staging \
            -r zap-baseline.html \
            -J zap-baseline.json \
            -w zap-baseline.md \
            -I || true
          
          echo "âœ… Baseline scan completed"

      # ğŸ”¹ ACTIVE SCAN - Full Scan
      - name: ZAP Full Scan (Active)
        run: |
          echo ""
          echo "ğŸ¯ =========================="
          echo "ğŸ¯ ZAP FULL ACTIVE SCAN"
          echo "ğŸ¯ =========================="
          echo "âš¡ This scan will actively test for vulnerabilities"
          echo "â±ï¸ Estimated time: 5-15 minutes"
          echo ""
          
          docker run --rm \
            --network dvwa-net \
            -v $(pwd)/zap-reports:/zap/wrk:rw \
            ghcr.io/zaproxy/zap-stable:latest \
            zap-full-scan.py \
            -t http://dvwa-staging \
            -r zap-active.html \
            -J zap-active.json \
            -w zap-active.md \
            -m 5 \
            -T 15 \
            -I || true
          
          echo "âœ… Active scan completed"

      # ğŸ“Š DETAILED ANALYSIS
      - name: Analyze ZAP Results in Detail
        run: |
          sudo apt-get install -y jq
          
          echo ""
          echo "ğŸ“Š =================================="
          echo "ğŸ“Š DAST COMPREHENSIVE ANALYSIS"
          echo "ğŸ“Š =================================="
          echo ""
          
          # Function to analyze a report
          analyze_report() {
            local report=$1
            local name=$2
            
            if [ -f "$report" ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ğŸ“„ $name"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              
              CRITICAL=$(jq '[.site[]?.alerts[]? | select(.riskcode=="4")] | length' "$report" 2>/dev/null || echo "0")
              HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' "$report" 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.site[]?.alerts[]? | select(.riskcode=="2")] | length' "$report" 2>/dev/null || echo "0")
              LOW=$(jq '[.site[]?.alerts[]? | select(.riskcode=="1")] | length' "$report" 2>/dev/null || echo "0")
              INFO=$(jq '[.site[]?.alerts[]? | select(.riskcode=="0")] | length' "$report" 2>/dev/null || echo "0")
              
              echo "ğŸ”´ Critical: $CRITICAL"
              echo "ğŸŸ  High: $HIGH"
              echo "ğŸŸ¡ Medium: $MEDIUM"
              echo "ğŸŸ¢ Low: $LOW"
              echo "â„¹ï¸  Info: $INFO"
              echo ""
              
              # Show Critical vulnerabilities
              if [ "$CRITICAL" -gt 0 ]; then
                echo "ğŸš¨ CRITICAL VULNERABILITIES FOUND:"
                jq -r '.site[]?.alerts[]? | select(.riskcode=="4") | "  â”œâ”€ \(.name)\n  â”‚  Instances: \(.count)\n  â”‚  Description: \(.desc | split("\n")[0])\n  â””â”€ Solution: \(.solution | split("\n")[0])\n"' "$report" 2>/dev/null || true
              fi
              
              # Show High vulnerabilities
              if [ "$HIGH" -gt 0 ]; then
                echo "âš ï¸  HIGH SEVERITY VULNERABILITIES:"
                jq -r '.site[]?.alerts[]? | select(.riskcode=="3") | "  â”œâ”€ \(.name)\n  â”‚  Instances: \(.count)\n  â”‚  Description: \(.desc | split("\n")[0])\n  â””â”€ Solution: \(.solution | split("\n")[0])\n"' "$report" 2>/dev/null || true
              fi
              
              echo ""
            else
              echo "âš ï¸ Report $report not found"
              echo ""
            fi
          }
          
          analyze_report "zap-reports/zap-baseline.json" "ZAP BASELINE SCAN (Passive)"
          analyze_report "zap-reports/zap-active.json" "ZAP ACTIVE SCAN"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # ğŸ”’ SECURITY GATE (Learning Mode)
      - name: DAST Security Gate (Learning Mode)
        run: |
          echo ""
          echo "ğŸ”“ =================================="
          echo "ğŸ”“ DAST SECURITY GATE: LEARNING MODE"
          echo "ğŸ”“ =================================="
          echo ""
          
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          
          # Check baseline report
          if [ -f "zap-reports/zap-baseline.json" ]; then
            BASELINE_CRIT=$(jq '[.site[]?.alerts[]? | select(.riskcode=="4")] | length' zap-reports/zap-baseline.json 2>/dev/null || echo "0")
            BASELINE_HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' zap-reports/zap-baseline.json 2>/dev/null || echo "0")
            TOTAL_CRITICAL=$((TOTAL_CRITICAL + BASELINE_CRIT))
            TOTAL_HIGH=$((TOTAL_HIGH + BASELINE_HIGH))
            echo "ğŸ“Š Baseline - Critical: $BASELINE_CRIT, High: $BASELINE_HIGH"
          fi
          
          # Check active scan report
          if [ -f "zap-reports/zap-active.json" ]; then
            ACTIVE_CRIT=$(jq '[.site[]?.alerts[]? | select(.riskcode=="4")] | length' zap-reports/zap-active.json 2>/dev/null || echo "0")
            ACTIVE_HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' zap-reports/zap-active.json 2>/dev/null || echo "0")
            TOTAL_CRITICAL=$((TOTAL_CRITICAL + ACTIVE_CRIT))
            TOTAL_HIGH=$((TOTAL_HIGH + ACTIVE_HIGH))
            echo "ğŸ“Š Active   - Critical: $ACTIVE_CRIT, High: $ACTIVE_HIGH"
          fi
          
          echo ""
          echo "ğŸ“ˆ TOTAL FINDINGS:"
          echo "   ğŸ”´ Critical: $TOTAL_CRITICAL"
          echo "   ğŸŸ  High: $TOTAL_HIGH"
          echo ""
          
          # Define thresholds for production
          CRITICAL_THRESHOLD=0
          HIGH_THRESHOLD=5
          
          echo "ğŸ¯ PRODUCTION THRESHOLDS:"
          echo "   Critical: $CRITICAL_THRESHOLD (max allowed)"
          echo "   High: $HIGH_THRESHOLD (max allowed)"
          echo ""
          
          # Learning Mode - Show what would happen
          if [ "${{ env.BLOCK_ON_VULNERABILITIES }}" = "true" ]; then
            echo "ğŸ”’ PRODUCTION MODE SIMULATION:"
            if [ "$TOTAL_CRITICAL" -gt "$CRITICAL_THRESHOLD" ]; then
              echo "   âŒ Would BLOCK: $TOTAL_CRITICAL critical vulnerabilities exceed threshold"
            elif [ "$TOTAL_HIGH" -gt "$HIGH_THRESHOLD" ]; then
              echo "   âš ï¸  Would WARN: $TOTAL_HIGH high vulnerabilities exceed threshold"
            else
              echo "   âœ… Would PASS: All findings within acceptable limits"
            fi
            echo ""
          fi
          
          echo "ğŸ”“ CURRENT MODE: LEARNING"
          echo "   âœ… Pipeline continues regardless of findings"
          echo "   ğŸ“š Purpose: Learn from DVWA's intentional vulnerabilities"
          echo "   ğŸ’¡ In production: Set BLOCK_ON_VULNERABILITIES=true"
          echo ""
          echo "ğŸ“ LEARNING POINTS:"
          echo "   â€¢ DVWA demonstrates common web vulnerabilities"
          echo "   â€¢ These findings show what DAST can detect"
          echo "   â€¢ Use this to understand security testing"
          echo "   â€¢ Never deploy vulnerable apps to production!"
          echo ""
          echo "âœ… DAST SCAN COMPLETED SUCCESSFULLY"

      - name: Generate DAST Summary Report
        run: |
          cat > zap-reports/SUMMARY.md <<'EOF'
          # ğŸ”’ DAST Security Scan Summary
          
          ## ğŸ“Š Scan Information
          - **Application**: DVWA (Damn Vulnerable Web Application)
          - **Purpose**: Security Testing & Learning
          - **Date**: $(date)
          - **Pipeline**: GitHub Actions DevSecOps
          
          ## âš ï¸ Important Notice
          DVWA is **intentionally vulnerable** for educational purposes.
          The vulnerabilities found are expected and demonstrate what DAST scanning can detect.
          
          ## ğŸ“ˆ Findings Overview
          Please review the detailed HTML and JSON reports in this artifact.
          
          ## ğŸ“ Learning Objectives
          - Understand common web vulnerabilities (OWASP Top 10)
          - Learn how DAST tools detect security issues
          - Practice analyzing security scan results
          - Experience DevSecOps pipeline integration
          
          ## ğŸš€ Next Steps
          1. Review the HTML reports for detailed findings
          2. Compare passive vs. active scan results
          3. Research each vulnerability type found
          4. Understand remediation strategies
          
          ## ğŸ”— Reports Available
          - `zap-baseline.html` - Passive scan results
          - `zap-active.html` - Active scan results
          - `zap-baseline.json` - Machine-readable baseline data
          - `zap-active.json` - Machine-readable active scan data
          
          ---
          **Remember**: Never deploy vulnerable applications to production!
          EOF
          
          echo "ğŸ“ Summary report generated"

      - name: Upload ZAP Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: zap-reports/
          retention-days: 30

      - name: Display Download Instructions
        if: always()
        run: |
          echo ""
          echo "ğŸ“¦ =================================="
          echo "ğŸ“¦ REPORTS READY FOR DOWNLOAD"
          echo "ğŸ“¦ =================================="
          echo ""
          echo "âœ… All DAST reports have been uploaded as artifacts"
          echo ""
          echo "ğŸ“¥ To download:"
          echo "   1. Go to Actions tab in GitHub"
          echo "   2. Click on this workflow run"
          echo "   3. Scroll to 'Artifacts' section"
          echo "   4. Download 'zap-dast-reports.zip'"
          echo ""
          echo "ğŸ“„ Reports included:"
          echo "   â€¢ zap-baseline.html (view in browser)"
          echo "   â€¢ zap-active.html (view in browser)"
          echo "   â€¢ zap-baseline.json (for automation)"
          echo "   â€¢ zap-active.json (for automation)"
          echo "   â€¢ SUMMARY.md (overview)"
          echo ""

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up resources..."
          docker rm -f dvwa-staging 2>/dev/null || true
          docker network rm dvwa-net 2>/dev/null || true
          echo "âœ… Cleanup completed"

  # =====================================
  # 6ï¸âƒ£ FINAL SUMMARY
  # =====================================
  pipeline_summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [sast_scan, secret_scan, sca_scan, image_scan, dast_scan]
    if: always()
    steps:
      - name: Pipeline Completion Summary
        run: |
          echo ""
          echo "ğŸ‰ =================================="
          echo "ğŸ‰ DEVSECOPS PIPELINE COMPLETED"
          echo "ğŸ‰ =================================="
          echo ""
          echo "ğŸ“Š Pipeline Stages:"
          echo "   âœ… SAST (Static Analysis)"
          echo "   âœ… Secret Scanning"
          echo "   âœ… SCA (Software Composition Analysis)"
          echo "   âœ… Container Image Scanning"
          echo "   âœ… DAST (Dynamic Application Security Testing)"
          echo ""
          echo "ğŸ“ Learning Mode Status:"
          echo "   ğŸ”“ Security Gates: DISABLED"
          echo "   ğŸ“š Purpose: Educational/Testing"
          echo "   âš ï¸  DVWA: Intentionally Vulnerable"
          echo ""
          echo "ğŸ’¡ Key Takeaways:"
          echo "   â€¢ Complete DevSecOps pipeline implemented"
          echo "   â€¢ Multiple security scanning techniques used"
          echo "   â€¢ DAST successfully tested against DVWA"
          echo "   â€¢ Reports generated for analysis"
          echo ""
          echo "ğŸš€ For Production Use:"
          echo "   1. Set BLOCK_ON_VULNERABILITIES=true"
          echo "   2. Define appropriate thresholds"
          echo "   3. Use secure, patched applications"
          echo "   4. Implement automated remediation"
          echo "   5. Add monitoring and alerting"
          echo ""
          echo "âœ… All stages completed successfully!"

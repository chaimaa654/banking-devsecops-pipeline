name: DVWA DevSecOps Pipeline

on:
  push:
    branches:
      - main

jobs:
  # =============================
  # 1Ô∏è‚É£ SAST ‚Äì SonarCloud (NON BLOQUANT TEMPORAIRE)
  # =============================
  sast_scan:
    name: SAST - SonarCloud Scan (Non Bloquant)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      
      - name: SonarCloud Scan (Non Bloquant)
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=chaimaa654_banking-devsecops-pipeline
            -Dsonar.organization=chaimaa654
            -Dsonar.sources=DVWA
            -Dsonar.qualitygate.wait=false

  # ==================================
  # 2Ô∏è‚É£ SCA ‚Äì Trivy FS (NON BLOQUANT TEMPORAIRE)
  # ==================================
  sca_scan:
    name: SCA - Trivy Filesystem Scan (Non Bloquant)
    runs-on: ubuntu-latest
    needs: sast_scan
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Trivy FS Scan (Non Bloquant)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scan-ref: ./DVWA
          severity: HIGH,CRITICAL
          exit-code: 0
          format: json
          output: trivy-sca-report.json
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-sca-report
          path: trivy-sca-report.json

  # ==================================
  # 3Ô∏è‚É£ IMAGE ‚Äì Docker + Trivy (NON BLOQUANT TEMPORAIRE)
  # ==================================
  image_scan:
    name: Docker Image Build (Non Bloquant)
    runs-on: ubuntu-latest
    needs: sca_scan
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Build DVWA Docker Image
        run: docker build -t dvwa:latest ./DVWA
      
      - name: Trivy Image Scan (Non Bloquant)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: image
          image-ref: dvwa:latest
          severity: HIGH,CRITICAL
          exit-code: 0
          format: json
          output: trivy-image-report.json
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-report
          path: trivy-image-report.json

  # ==================================
  # 4Ô∏è‚É£ DAST ‚Äì OWASP ZAP (PRINCIPAL)
  # ==================================
  dast_scan:
    name: DAST - OWASP ZAP
    runs-on: ubuntu-latest
    needs: image_scan
    
    steps:
      - uses: actions/checkout@v3
      
      # üîπ Cr√©er un r√©pertoire pour les rapports ZAP
      - name: Create ZAP reports directory
        run: mkdir -p ${{ github.workspace }}/zap-reports
      
      # üîπ Construire DVWA Docker Image
      - name: Build DVWA Docker Image
        run: docker build -t dvwa:latest ./DVWA
      
      # üîπ Lancer DVWA dans un container
      - name: Run DVWA container
        run: docker run -d --name dvwa-staging -p 8080:80 dvwa:latest
      
      - name: Wait for DVWA
        run: sleep 20
      
      # üîπ V√©rifier que DVWA est accessible
      - name: Check DVWA is running
        run: curl -f http://localhost:8080 || exit 1
      
      # üîπ Lancer ZAP Baseline Scan
      - name: OWASP ZAP Baseline Scan
        run: |
          docker run --rm --network host \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk/:rw \
            -u root \
            ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
            -t http://localhost:8080 \
            -r zap-report.html \
            -J zap-report.json \
            -I || true
      
      # üîπ Afficher le contenu du r√©pertoire (debug)
      - name: List ZAP reports
        if: always()
        run: ls -la ${{ github.workspace }}/zap-reports/
      
      # üîπ Upload rapport DAST
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-dast-report
          path: ${{ github.workspace }}/zap-reports/
      
      # üîπ Stop DVWA container
      - name: Stop DVWA container
        if: always()
        run: docker rm -f dvwa-staging

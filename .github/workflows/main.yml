name: DVWA DevSecOps Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: dvwa
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ==========================
  # 1Ô∏è‚É£ SAST ‚Äì SonarCloud
  # ==========================
  sast_scan:
    name: SAST - SonarCloud Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=chaimaa654_banking-devsecops-pipeline
            -Dsonar.organization=chaimaa654
            -Dsonar.sources=DVWA
            -Dsonar.qualitygate.wait=true

      - name: Check Quality Gate
        run: |
          echo "‚úÖ SAST Quality Gate Check Completed"

  # ====================================
  # 2Ô∏è‚É£ SECRET SCANNING ‚Äì Gitleaks
  # ====================================
  secret_scan:
    name: Secret Scanning - Gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ==================================
  # 3Ô∏è‚É£ SCA ‚Äì Trivy Filesystem Scan
  # ==================================
  sca_scan:
    name: SCA - Trivy Filesystem Scan
    runs-on: ubuntu-latest
    needs: [sast_scan, secret_scan]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Trivy SCA Scan
        run: |
          trivy fs --severity HIGH,CRITICAL ./DVWA
        continue-on-error: true

      - name: Generate SCA Report
        run: |
          trivy fs --format json --output trivy-sca-report.json ./DVWA

      - name: Upload SCA Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sca-report
          path: trivy-sca-report.json

      - name: SCA Security Gate
        run: |
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-sca-report.json)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-sca-report.json)
          
          echo "üìä SCA Results - Critical: $CRITICAL, High: $HIGH"
          
          if [ "$CRITICAL" -gt 5 ]; then
            echo "‚ùå Too many CRITICAL vulnerabilities found!"
            exit 1
          fi
          
          echo "‚úÖ SCA Security Gate PASSED"

  # ====================================
  # 4Ô∏è‚É£ Docker Build & Image Security
  # ====================================
  image_scan:
    name: Docker Image Build & Scan
    runs-on: ubuntu-latest
    needs: sca_scan
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ./DVWA
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ env.IMAGE_NAME }}:latest

      - name: Trivy Image Scan
        run: |
          trivy image --severity HIGH,CRITICAL ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        continue-on-error: true

      - name: Generate Image Scan Report
        run: |
          trivy image --format json --output trivy-image-report.json ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      - name: Upload Image Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-report
          path: trivy-image-report.json

      - name: Image Security Gate
        run: |
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-image-report.json)
          
          echo "üìä Image Scan - Critical: $CRITICAL"
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "‚ö†Ô∏è WARNING: Critical vulnerabilities found in image"
            # exit 1  # D√©commentez pour bloquer le pipeline
          fi
          
          echo "‚úÖ Image Security Gate PASSED"

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REPO_USER }}
          password: ${{ secrets.REPO_PWD }}

      - name: Push Docker Image
        run: |
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest

  # =====================================
  # 5Ô∏è‚É£ DAST ‚Äì ZAP Security Testing
  # =====================================
  dast_scan:
    name: DAST - ZAP Security Scan
    runs-on: ubuntu-latest
    needs: image_scan
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.REPO_USER }}
          password: ${{ secrets.REPO_PWD }}

      - name: Pull Docker Image
        run: |
          docker pull ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest

      - name: Create Docker Network
        run: |
          docker network create dvwa-net || true

      - name: Deploy DVWA Staging
        run: |
          docker run -d \
            --name dvwa-staging \
            --network dvwa-net \
            -p 8080:80 \
            -e RECAPTCHA_PRIV_KEY='' \
            -e RECAPTCHA_PUB_KEY='' \
            ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:latest

      - name: Wait for DVWA to Start
        run: |
          echo "üîç Waiting for DVWA to be ready..."
          for i in {1..60}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 || echo "000")
            if [[ "$HTTP_CODE" == "200" ]] || [[ "$HTTP_CODE" == "302" ]]; then
              echo "‚úÖ DVWA is ready! (HTTP $HTTP_CODE)"
              curl -I http://localhost:8080
              break
            fi
            echo "‚è≥ Attempt $i/60 - HTTP Code: $HTTP_CODE - waiting..."
            sleep 5
            
            if [ $i -eq 60 ]; then
              echo "‚ùå DVWA failed to start!"
              docker logs dvwa-staging
              exit 1
            fi
          done

      - name: Configure DVWA
        run: |
          echo "‚öôÔ∏è Configuring DVWA for testing..."
          sleep 10
          
          # V√©rifier si DVWA n√©cessite une configuration initiale
          docker exec dvwa-staging ls -la /var/www/html/ || true
          
          # Tenter d'acc√©der √† la page de setup
          curl -v http://localhost:8080/setup.php || true

      - name: Create ZAP Reports Directory
        run: |
          mkdir -p zap-reports

      # üîπ PASSIVE SCAN - Baseline
      - name: ZAP Baseline Scan (Passive)
        run: |
          echo "üîç Running ZAP Baseline Scan..."
          docker run --rm \
            --network dvwa-net \
            -v $(pwd)/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zap-stable:latest \
            zap-baseline.py \
            -t http://dvwa-staging \
            -r zap-baseline.html \
            -J zap-baseline.json \
            -w zap-baseline.md \
            -I || true

      # üîπ ACTIVE SCAN - Full Scan
      - name: ZAP Full Scan (Active)
        run: |
          echo "üéØ Running ZAP Full Active Scan..."
          docker run --rm \
            --network dvwa-net \
            -v $(pwd)/zap-reports:/zap/wrk \
            ghcr.io/zaproxy/zap-stable:latest \
            zap-full-scan.py \
            -t http://dvwa-staging \
            -r zap-active.html \
            -J zap-active.json \
            -w zap-active.md \
            -m 5 \
            -T 15 \
            -I || true

      # üîπ AUTHENTICATED SCAN (Optionnel - pour tests plus profonds)
      - name: ZAP Authenticated Scan
        run: |
          echo "üîê Running Authenticated Scan..."
          
          # Cr√©er un script de contexte pour l'authentification
          cat > zap-reports/auth-script.js <<'EOF'
          function authenticate(helper, paramsValues, credentials) {
            var loginUrl = "http://dvwa-staging/login.php";
            var postData = "username=" + encodeURIComponent(credentials.getParam("Username")) + 
                          "&password=" + encodeURIComponent(credentials.getParam("Password")) + 
                          "&Login=Login";
            
            var msg = helper.prepareMessage();
            msg.setRequestHeader("POST " + loginUrl + " HTTP/1.1");
            msg.setRequestBody(postData);
            helper.sendAndReceive(msg);
            
            return msg;
          }
          
          function getRequiredParamsNames() {
            return ["Username", "Password"];
          }
          
          function getOptionalParamsNames() {
            return [];
          }
          
          function getCredentialsParamsNames() {
            return ["Username", "Password"];
          }
          EOF
          
          # Note: Pour un scan authentifi√© complet, vous auriez besoin de configurer
          # un contexte ZAP avec le script ci-dessus. C'est plus complexe et n√©cessite
          # une configuration ZAP personnalis√©e.

      # üìä ANALYZE RESULTS
      - name: Analyze ZAP Results
        run: |
          sudo apt-get install -y jq
          
          echo "üìä =========================="
          echo "üìä DAST SCAN RESULTS"
          echo "üìä =========================="
          
          # Function to analyze a report
          analyze_report() {
            local report=$1
            local name=$2
            
            if [ -f "$report" ]; then
              echo ""
              echo "üìÑ $name Analysis:"
              echo "----------------------------"
              
              CRITICAL=$(jq '[.site[]?.alerts[]? | select(.riskcode=="4")] | length' "$report" 2>/dev/null || echo "0")
              HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' "$report" 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.site[]?.alerts[]? | select(.riskcode=="2")] | length' "$report" 2>/dev/null || echo "0")
              LOW=$(jq '[.site[]?.alerts[]? | select(.riskcode=="1")] | length' "$report" 2>/dev/null || echo "0")
              INFO=$(jq '[.site[]?.alerts[]? | select(.riskcode=="0")] | length' "$report" 2>/dev/null || echo "0")
              
              echo "üî¥ Critical: $CRITICAL"
              echo "üü† High: $HIGH"
              echo "üü° Medium: $MEDIUM"
              echo "üü¢ Low: $LOW"
              echo "‚ÑπÔ∏è  Info: $INFO"
              
              # Afficher les vuln√©rabilit√©s critiques
              if [ "$CRITICAL" -gt 0 ]; then
                echo ""
                echo "üö® Critical Vulnerabilities:"
                jq -r '.site[]?.alerts[]? | select(.riskcode=="4") | "  - \(.name) (\(.count) instances)"' "$report" 2>/dev/null || true
              fi
              
              if [ "$HIGH" -gt 0 ]; then
                echo ""
                echo "‚ö†Ô∏è  High Vulnerabilities:"
                jq -r '.site[]?.alerts[]? | select(.riskcode=="3") | "  - \(.name) (\(.count) instances)"' "$report" 2>/dev/null || true
              fi
            else
              echo "‚ö†Ô∏è Report $report not found"
            fi
          }
          
          analyze_report "zap-reports/zap-baseline.json" "ZAP Baseline (Passive)"
          analyze_report "zap-reports/zap-active.json" "ZAP Active Scan"

      # üîí SECURITY GATE
      - name: DAST Security Gate
        run: |
          echo ""
          echo "üîí =========================="
          echo "üîí SECURITY GATE EVALUATION"
          echo "üîí =========================="
          
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          
          # Check baseline report
          if [ -f "zap-reports/zap-baseline.json" ]; then
            BASELINE_CRIT=$(jq '[.site[]?.alerts[]? | select(.riskcode=="4")] | length' zap-reports/zap-baseline.json 2>/dev/null || echo "0")
            BASELINE_HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' zap-reports/zap-baseline.json 2>/dev/null || echo "0")
            TOTAL_CRITICAL=$((TOTAL_CRITICAL + BASELINE_CRIT))
            TOTAL_HIGH=$((TOTAL_HIGH + BASELINE_HIGH))
          fi
          
          # Check active scan report
          if [ -f "zap-reports/zap-active.json" ]; then
            ACTIVE_CRIT=$(jq '[.site[]?.alerts[]? | select(.riskcode=="4")] | length' zap-reports/zap-active.json 2>/dev/null || echo "0")
            ACTIVE_HIGH=$(jq '[.site[]?.alerts[]? | select(.riskcode=="3")] | length' zap-reports/zap-active.json 2>/dev/null || echo "0")
            TOTAL_CRITICAL=$((TOTAL_CRITICAL + ACTIVE_CRIT))
            TOTAL_HIGH=$((TOTAL_HIGH + ACTIVE_HIGH))
          fi
          
          echo "üìä Total Critical: $TOTAL_CRITICAL"
          echo "üìä Total High: $TOTAL_HIGH"
          echo ""
          
          # Define thresholds
          CRITICAL_THRESHOLD=0
          HIGH_THRESHOLD=10
          
          # Security Gate Logic
          if [ "$TOTAL_CRITICAL" -gt "$CRITICAL_THRESHOLD" ]; then
            echo "‚ùå SECURITY GATE FAILED!"
            echo "   Reason: $TOTAL_CRITICAL critical vulnerabilities found (threshold: $CRITICAL_THRESHOLD)"
            echo "   Action: Please review and fix critical vulnerabilities before deployment"
            # exit 1  # D√©commentez pour bloquer le d√©ploiement
            echo "‚ö†Ô∏è  WARNING MODE: Pipeline continues but deployment should be reviewed"
          elif [ "$TOTAL_HIGH" -gt "$HIGH_THRESHOLD" ]; then
            echo "‚ö†Ô∏è  SECURITY GATE WARNING!"
            echo "   Reason: $TOTAL_HIGH high vulnerabilities found (threshold: $HIGH_THRESHOLD)"
            echo "   Action: Review high-severity issues"
          else
            echo "‚úÖ SECURITY GATE PASSED!"
            echo "   All security checks within acceptable thresholds"
          fi

      - name: Upload ZAP Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-dast-reports
          path: zap-reports/

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          docker rm -f dvwa-staging || true
          docker network rm dvwa-net || true

  # =====================================
  # 6Ô∏è‚É£ DEPLOY TO STAGING (Post-DAST)
  # =====================================
  deploy_staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: dast_scan
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Staging
        run: |
          echo "üöÄ Deploying to Staging Environment..."
          echo "   Image: ${{ secrets.REPO_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          # Ajoutez ici votre logique de d√©ploiement
          # Exemple: kubectl, docker-compose, AWS ECS, etc.

  # =====================================
  # 7Ô∏è‚É£ NOTIFICATION
  # =====================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [dast_scan]
    if: always()
    steps:
      - name: Notify on Success
        if: needs.dast_scan.result == 'success'
        run: |
          echo "‚úÖ Pipeline completed successfully!"
          # Ajoutez Slack/Teams/Email notification ici

      - name: Notify on Failure
        if: needs.dast_scan.result == 'failure'
        run: |
          echo "‚ùå Pipeline failed! Check the logs."
          # Ajoutez Slack/Teams/Email notification ici
```

## üìã Fichiers de Configuration Suppl√©mentaires

### 1. `.trivyignore` (optionnel)
Cr√©ez ce fichier √† la racine pour ignorer certaines vuln√©rabilit√©s :
```
# Ignore specific CVEs
CVE-2023-12345

# Ignore by package
pkg:composer/symfony/http-kernel
